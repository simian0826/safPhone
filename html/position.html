<!doctype html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
   <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
  <title>自己做着玩</title>
  <link rel="stylesheet" type="text/css" href="/safPhone/css/initialize.css">
  <link rel="stylesheet" type="text/css" href="/safPhone/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/safPhone/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/safPhone/css/main.css">


  <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=0339a9e4f17c228650d6a412aa9b07c7&plugin=AMap.PolyEditor,AMap.CircleEditor"></script>


</head>

<body style="opacity:0;transition:opacity .5s">
  <nav class="navbar navbar-default text-center state-bar" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a href="#"><i class="glyphicon glyphicon-exclamation-sign navbar-return"></i></a>
        <span class="navbar-text navbar-title clearfloat">小明</span>
      </div>
    </div>
  </nav>
  <div class="btn-group-vertical toolbar">
    <button type="button" id="path" class="btn btn-default" data-toggle="modal" data-target="#pathModal">轨迹</button>
    <button type="button" id="fence" class="btn btn-default" data-toggle="modal" data-target="#fenceModal">围栏</button>
    <button type="button" id="trace" class="btn btn-default">追踪</button>
    <button type="button" id="center" class="btn btn-default">定位</button>
  </div>
  <button id='circleConfirm' class='btn btn-warning circleConfirm'>确定</button>
  <div id="container" style="width:100%; height:92%"></div>



  <!-- 模态框（Modal） -->
  <div class="modal fade" id="fenceModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-header">
              <span id="fenceAdd">添加</span>
              <h4 class="modal-title" id="myModalLabel">电子围栏</h4>
        </div>
        <div class="modal-body">

        </div>

      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
  </div>

  <div class="modal fade" id="pathModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-body">
          <div class="btn-group">
            <button  type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span id="pathDate" value="0">今天</span>
              <span class="caret"></span>
            </button>
            <ul id="pathDateMenu" class="dropdown-menu" role="menu">
              <li>
                <a href="#" value="-2">前天</a>
              </li>
              <li>
                <a href="#" value="-1">昨天</a>
              </li>
              <li>
                <a href="#" value="0">今天</a>
              </li>
          </ul>
          </div>
          <div class="btn-group">
            <button  type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span id="pathType" value="2">精确轨迹</span>
              <span class="caret"></span>
            </button>
            <ul id="pathTypeMenu" class="dropdown-menu" role="menu">
              <li>
                <a href="#" value="2">精确轨迹</a>
              </li>
              <li>
                <a href="#" value="1">混合轨迹</a>
              </li>

          </ul>
          </div>
          <div class="btn-group">
            <button id="searchPath" type="button" data-dismiss="modal" class="btn btn-primary">查询轨迹</button>
          </div>
        </div>

      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
  </div>


  <div id="fenceAddAlert" class="alert alert-danger">
    <a href="#" class="close" data-dismiss="alert">&times;</a>
    <strong>请在地图上画出圆形围栏区域</strong>
    </div>

  <script src="/safPhone/js/jquery.js"></script>
  <script src="/safPhone/js/jquery.cookie.js"></script>
  <script src="/safPhone/js/bootstrap.min.js"></script>
  <script>
  var timer;
  var latestLocationInfo;
  var mapOption =  {
    resizeEnable: true,
    center: [106.5481624, 29.5150453],
    zoom: 13,
    mapStyle:'amap://styles/normal'
  };
  var markerOption = {
    icon: "http://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
    position: ""
  };
  $.ajax({
     url: 'http://edu.winsaf.com:9999/location/latestLocation',
     type: "POST",
     contentType: "application/json",
     async: false,
     headers: {
        "token" : $.cookie("token"),
        "userID" : $.cookie("userID")
      },
     data:JSON.stringify({imei:  $.cookie("deviceID")}),
     success: function(data){
      console.log(data);
      latestLocationInfo = data;

      if (!$.isEmptyObject(latestLocationInfo)) {
        mapOption.center = [latestLocationInfo.point.lon, latestLocationInfo.point.lat];
        markerOption.position = [latestLocationInfo.point.lon, latestLocationInfo.point.lat];
      }
     },
     error:function(){
      console.log(data);
     }
    });
  //地图初始化
  var map = new AMap.Map('container',mapOption);
  //获取到最近位置之后点标记出中心点
  if(markerOption.position != ""){
    marker = new AMap.Marker(markerOption);
    marker.setMap(map);
  }



$(function() {
  $("body").css("opacity", 1);

});



//查询电子围栏
$("#fence").click(function(){

});

  //电子围栏添加
$("#fenceAdd").click(function(){
  map.clearMap();
  $("#fenceModal").modal("hide");
  $("#fenceAddAlert").fadeIn(500);
  setTimeout(function(){
    $("#fenceAddAlert").fadeOut(500);
  },3000);
  var editor = {};
  editor._circle = (function(){
      var center = map.getCenter();

      var circle = new AMap.Circle({
          center: [center.lng, center.lat],// 圆心位置
          radius: 600, //半径
          strokeColor: "#F33", //线颜色
          strokeOpacity: 1, //线透明度
          strokeWeight: 3, //线粗细度
          fillColor: "#ee2200", //填充颜色
          fillOpacity: 0.35//填充透明度
      });
      circle.setMap(map);
      return circle;
  })();
  map.setFitView();

  editor._circleEditor = new AMap.CircleEditor(map, editor._circle);
  editor._circleEditor.open();
  //$(".amap-marker-label").before("<button id='circleConfirm' class='btn btn-default circleConfirm'>确定</button>");
  $("#circleConfirm").click(function() {
    editor._circleEditor.close();
    $("#circleConfirm").fadeOut(100);
  });


  $("#circleConfirm").fadeIn(100);
});


$("#center").click(function(){
  var center = map.getCenter()
    console.log(center);
    console.log(center.lng);
    console.log(center.lat);

});





//轨迹时间类型选择
$("#pathTypeMenu a").click(function() {
  $("#pathType").text($(this).text());
  $("#pathType").attr("value", $(this).attr("value"));
});
$("#pathDateMenu a").click(function() {
  $("#pathDate").text($(this).text());
  $("#pathDate").attr("value", $(this).attr("value"));
});

//轨迹查询
$("#searchPath").click(function(){
  var pathInfo;
  var today = new Date();
  var yesterday = new Date();
  var theDayBeforeYesterday = new Date();


  var todayStart = today.getFullYear()+"-" + (today.getMonth()+1) + "-" + today.getDate() + " " + "00-00-00";
  var todayEnd = today.getFullYear()+"-" + (today.getMonth()+1) + "-" + today.getDate() + " " + today.getHours() + "-" + today.getMinutes() + "-" +  today.getSeconds();
  yesterday.setTime(yesterday.getTime() - 24*60*60*1000);
  var yesterdayStart = yesterday.getFullYear()+"-" + (yesterday.getMonth()+1) + "-" + yesterday.getDate() + " " + "00-00-00";
  var yesterdayEnd = yesterday.getFullYear()+"-" + (yesterday.getMonth()+1) + "-" + yesterday.getDate() + " " + "23-59-59";
  theDayBeforeYesterday.setTime(today.getTime() - 3*24*60*60*1000);
  var theDayBeforeYesterdayStart = theDayBeforeYesterday.getFullYear()+"-" + (theDayBeforeYesterday.getMonth()+1) + "-" + theDayBeforeYesterday.getDate() + " " + "00-00-00";
  var theDayBeforeYesterdayEnd = theDayBeforeYesterday.getFullYear()+"-" + (theDayBeforeYesterday.getMonth()+1) + "-" + theDayBeforeYesterday.getDate() + " " + "23-59-59";

  var start, end, mode;
  switch ($("#pathDate").attr("value")) {
    case "-2":
      start = theDayBeforeYesterdayStart;
      end = theDayBeforeYesterdayEnd;
      break;
    case "-1":
    start = yesterdayStart;
    end = yesterdayEnd;
      break;
    case "0":
    start = todayStart;
    end = todayEnd;
      break;
  }
  if($("#pathType").attr("value") == 1){
    mode = 1;
  }else {
    mode = 2;
  }

  var requestData = {
    imei: $.cookie("deviceID"),
    start: start,
    end: end
  }

  console.log(requestData);

  $.ajax({
     url: 'http://edu.winsaf.com:9999/locationHistroyRead/getLocationHistory',
     type: "POST",
     contentType: "application/json",
     async: false,
     headers: {
        "token" : $.cookie("token"),
        "userID" : $.cookie("userID")
      },
     data:JSON.stringify(requestData),
     success: function(data){
      console.log(data);
      pathInfo = data;
      if (!$.isEmptyObject(pathInfo)) {
        cleanMap();
        map.panTo([pathInfo.trackList[0].point.lon, pathInfo.trackList[0].point.lat]);

        var path = [];
        for (var i = 0; i < pathInfo.trackList.length; i++) {
          path.push([pathInfo.trackList[i].point.lon, pathInfo.trackList[i].point.lat]);
        }
        console.log(path);
        var polyline = new AMap.Polyline({
          path: path, //设置线覆盖物路径
          strokeColor: "#3366FF", //线颜色
          strokeOpacity: 1, //线透明度
          strokeWeight: 6, //线宽
          strokeStyle: "dashed ", //线样式
          lineJoin:"round",
          strokeDasharray: [10,2,10] , //补充线样式
          showDir:true
        });
        var markerChild = new AMap.Marker({
            map: map,
            position: [pathInfo.trackList[0].point.lon, pathInfo.trackList[0].point.lat],
            icon: "http://webapi.amap.com/images/car.png",
            content:"<i class='fa fa-child fa-2x'></i>",
            offset: new AMap.Pixel(-10, -13),
            autoRotation: false
        });

        polyline.setMap(map);

        markerChild.setMap(map);

        markerChild.moveAlong(path, 5000);

      }
     },
     error:function(){
      console.log(data);
     }
    });



});

$("#trace").click(function() {

  var tracePath = new Array();
  var openTracingRequest = {
    deviceID :  $.cookie("deviceID"),
    time : 5,
    freq  : 30
  }
  $.ajax({
     url: 'http://edu.winsaf.com:9999/edu/deviceMgmt/openTracking',
     type: "POST",
     contentType: "application/json",
     async: false,
     headers: {
        "token" : $.cookie("token"),
        "userID" : $.cookie("userID")
      },
     data:JSON.stringify(openTracingRequest),
     success: function(data){
      console.log(data);
      cleanMap();
      if (data.rspCode == 1) {
        timer = setInterval(function(){
          console.log(tracePath);
          pushTracingPath(tracePath);
          drawPath(tracePath);
        }, 1000);
      }else if (data.rspCode == 2243) {
        alert("设备离线")
      }else if(data.rspCode == 2242){
        alert("未找到设备")
      }
     },
     error:function(){
      console.log(data);
     }
    });

});


$("button").not("#trace").click(function(){
  if(timer != null ){
    clearInterval(timer);
  }

});

  // setTimeout(function() {
  //   lineArr.push([106.490955,29.525593]);
  //   polyline.setPath(lineArr);
  //   polyline.setMap(map);
  // }, 3000);



  //工具栏
  map.plugin(["AMap.ToolBar", 'AMap.Scale', 'AMap.MapType'], function() {
    map.addControl(new AMap.ToolBar());
    map.addControl(new AMap.Scale());
    map.addControl(new AMap.MapType());
  });


function circleConfirm(){
  alert("a");

}

//清除地图上的标记，并重新标记当前位置
function cleanMap(){
    map.clearMap();
    marker.setMap(map);
}

//获取当前位置
function getLastLocation(){
  var point = {
    lat: "",
    lon : ""
  }
  $.ajax({
     url: 'http://edu.winsaf.com:9999/location/latestLocation',
     type: "POST",
     contentType: "application/json",
     async: false,
     headers: {
        "token" : $.cookie("token"),
        "userID" : $.cookie("userID")
      },
     data:JSON.stringify({imei:  $.cookie("deviceID")}),
     success: function(data){
      console.log(data);
      latestLocationInfo = data;

      if (!$.isEmptyObject(latestLocationInfo)) {
        point.lat = latestLocationInfo.point.lat;
        point.lon = latestLocationInfo.point.lon;


    }else {

    }
     },
     error:function(){
      console.log(data);
     }
    });
      return point;
}

//将获取到的最新位置添加到传入的数组中
function pushTracingPath(path){
  var point = getLastLocation()
  console.log(point);
  path.push([point.lon, point.lat]);
}

//将传入的Path画在地图上
function drawPath(path) {
  cleanMap();
  var traceLine = new AMap.Polyline({
    path: path, //设置线覆盖物路径
    strokeColor: "#3366FF", //线颜色
    strokeOpacity: 1, //线透明度
    strokeWeight: 6, //线宽
    strokeStyle: "dashed ", //线样式
    lineJoin:"round",
    strokeDasharray: [10,2,10] , //补充线样式
    showDir:true
  });

  traceLine.setMap(map);
}

</script>
</body>

</html>
